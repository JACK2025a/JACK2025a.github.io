<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LexiFlow Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;700&family=Noto+Sans+SC:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            --md-sys-color-primary: #006493;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #cae6ff;
            --md-sys-color-on-primary-container: #001e30;
            --md-sys-color-surface: #f8f9ff;
            --md-sys-color-surface-container: #f0f4f9;
            --md-sys-color-on-surface: #191c1e;
            --md-sys-color-outline: #72777f;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-success: #14a34b;
        }
        .dark {
            --md-sys-color-primary: #8dcdff;
            --md-sys-color-on-primary: #00344f;
            --md-sys-color-primary-container: #004b70;
            --md-sys-color-on-primary-container: #cae6ff;
            --md-sys-color-surface: #101416;
            --md-sys-color-surface-container: #1d2024;
            --md-sys-color-on-surface: #c5c7ce;
        }
        body {
            font-family: 'DM Sans', 'Noto Sans SC', sans-serif;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: background-color 0.3s ease, color 0.3s ease;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }
        .card {
            background-color: var(--md-sys-color-surface-container);
            border-radius: 20px;
            transition: all 0.2s;
        }
        .btn-filled {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-radius: 24px;
            padding: 0 24px;
            height: 48px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: box-shadow 0.2s, transform 0.1s;
            cursor: pointer;
        }
        .btn-filled:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-filled:active { transform: scale(0.98); }
        .btn-tonal {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-radius: 24px;
            padding: 0 24px;
            height: 48px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }
        .btn-danger-tonal {
            background-color: #ffdad6;
            color: #410002;
            border-radius: 24px;
            padding: 0 24px;
            height: 48px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }
        .dark .btn-danger-tonal { background-color: #93000a; color: #ffb4ab; }
        .nav-rail-item {
            height: 56px;
            width: 80px;
            border-radius: 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            color: var(--md-sys-color-on-surface);
            transition: all 0.2s;
            gap: 4px;
            padding: 12px 0;
            cursor: pointer;
        }
        .nav-rail-item.active {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }
        .nav-rail-item .icon { font-size: 24px; }
        .nav-rail-item .label { font-size: 11px; font-weight: 500; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--md-sys-color-outline); border-radius: 4px; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        .shake-anim { animation: shake 0.4s ease-in-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .slide-up-anim { animation: slideUp 0.3s ease-out forwards; }

        /* Key badge */
        .key-badge {
            display: inline-flex;
            align-items: center;
            background: var(--md-sys-color-surface);
            border: 1.5px solid var(--md-sys-color-outline);
            border-radius: 6px;
            padding: 1px 6px;
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.03em;
            box-shadow: 0 2px 0 rgba(0,0,0,0.12);
            white-space: nowrap;
        }
        .dark .key-badge {
            background: #2a2d30;
            border-color: #555;
            box-shadow: 0 2px 0 rgba(0,0,0,0.3);
        }

        /* Keybind row in settings */
        .keybind-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 12px;
            background: var(--md-sys-color-surface);
            border: 1px solid rgba(0,0,0,0.08);
            transition: background 0.15s;
        }
        .dark .keybind-row { border-color: rgba(255,255,255,0.08); background: rgba(255,255,255,0.04); }
        .keybind-row:hover { background: rgba(0,100,147,0.06); }

        /* Recording state */
        .recording-btn {
            animation: pulse-record 1s ease-in-out infinite;
            background: #fef3c7 !important;
            border-color: #f59e0b !important;
        }
        .dark .recording-btn { background: #451a03 !important; border-color: #f59e0b !important; }
        @keyframes pulse-record {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245,158,11,0.4); }
            50% { box-shadow: 0 0 0 6px rgba(245,158,11,0); }
        }

        /* Voice selector */
        select {
            background: var(--md-sys-color-surface);
            border: 1.5px solid rgba(0,0,0,0.15);
            border-radius: 10px;
            padding: 8px 12px;
            color: var(--md-sys-color-on-surface);
            font-family: inherit;
            font-size: 13px;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        select:focus { border-color: var(--md-sys-color-primary); }
        .dark select { border-color: rgba(255,255,255,0.15); background: #1d2024; }

        /* TTS test button */
        .tts-test-btn {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            cursor: pointer;
            transition: opacity 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .tts-test-btn:hover { opacity: 0.85; }

        /* Voice quality badge */
        .voice-online { color: #16a34a; }
        .voice-local { color: #9ca3af; }
        .dark .voice-online { color: #4ade80; }

        /* Settings section header */
        .settings-section-header {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            opacity: 0.5;
            padding: 16px 16px 6px;
        }
    </style>
</head>
<body class="flex">

    <nav class="w-24 h-full bg-[var(--md-sys-color-surface)] border-r border-black/5 dark:border-white/5 flex flex-col items-center py-6 z-20">
        <div class="mb-8 p-2 bg-[var(--md-sys-color-primary)] text-white rounded-xl">
            <span class="material-icons-round text-2xl">school</span>
        </div>
        <button onclick="app.nav('dashboard')" id="nav-dashboard" class="nav-rail-item active">
            <span class="material-icons-round icon">dashboard</span>
            <span class="label">æ¦‚è§ˆ</span>
        </button>
        <button onclick="app.nav('review')" id="nav-review" class="nav-rail-item">
            <span class="material-icons-round icon">event_repeat</span>
            <span class="label">å¤ä¹ </span>
        </button>
        <button onclick="app.nav('library')" id="nav-library" class="nav-rail-item">
            <span class="material-icons-round icon">book</span>
            <span class="label">è¯åº“</span>
        </button>
        <button onclick="app.nav('settings')" id="nav-settings" class="nav-rail-item mt-auto">
            <span class="material-icons-round icon">settings</span>
            <span class="label">è®¾ç½®</span>
        </button>
    </nav>

    <main class="flex-1 h-full relative overflow-hidden">
        <div id="toast-container" class="absolute bottom-8 left-1/2 -translate-x-1/2 z-[60] flex flex-col gap-2 pointer-events-none"></div>

        <!-- DASHBOARD -->
        <div id="view-dashboard" class="view-page w-full h-full overflow-y-auto p-8">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold">å­¦ä¹ æ¦‚è§ˆ</h1>
                    <p class="text-sm opacity-60">åšæŒå­¦ä¹ ï¼Œå¯¹æŠ—é—å¿˜ã€‚</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="app.toggleTheme()" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                        <span class="material-icons-round" id="theme-icon">dark_mode</span>
                    </button>
                </div>
            </header>
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="card p-5">
                    <div class="text-xs font-bold opacity-60 uppercase">ä»Šæ—¥æ—¶é•¿</div>
                    <div class="text-3xl font-bold mt-1" id="stat-time">0m</div>
                </div>
                <div class="card p-5">
                    <div class="text-xs font-bold opacity-60 uppercase">å·²æŒæ¡å•è¯</div>
                    <div class="text-3xl font-bold mt-1 text-green-600 dark:text-green-400" id="stat-mastered">0</div>
                </div>
                <div class="card p-5">
                    <div class="text-xs font-bold opacity-60 uppercase">å¾…å¤ä¹ </div>
                    <div class="text-3xl font-bold mt-1 text-orange-600 dark:text-orange-400" id="stat-due">0</div>
                </div>
                <div class="card p-5">
                    <div class="text-xs font-bold opacity-60 uppercase">ä»Šæ—¥æ–°å­¦</div>
                    <div class="text-3xl font-bold mt-1"><span id="stat-learned">0</span></div>
                </div>
            </div>
            <div class="card p-4 mb-6 flex items-center gap-4">
                <div class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100 p-2 rounded-lg flex items-center gap-2 px-3">
                    <span class="material-icons-round text-sm">emoji_events</span>
                    <span class="text-xs font-bold">ä»Šæ—¥æ–°æ–©è·</span>
                </div>
                <div id="mastered-ticker" class="flex-1 overflow-hidden whitespace-nowrap text-sm opacity-70">
                    æš‚æ— æ–°æŒæ¡å•è¯ï¼Œå¿«å»å­¦ä¹ å§ï¼
                </div>
            </div>
            <div class="grid grid-cols-3 gap-6 h-64">
                <div onclick="app.startSession('learn')" class="card col-span-2 p-8 relative overflow-hidden cursor-pointer hover:shadow-lg transition-all group bg-gradient-to-br from-[var(--md-sys-color-primary)] to-blue-800 text-white">
                    <div class="relative z-10 h-full flex flex-col justify-between">
                        <div>
                            <h2 class="text-3xl font-bold mb-2">å¼€å§‹å­¦ä¹ </h2>
                            <p class="opacity-80">æ™ºèƒ½æ¨é€ï¼šæ–°è¯ (å¤šè½®) + é”™è¯ + åˆ°æœŸå¤ä¹ </p>
                        </div>
                        <div class="flex gap-2">
                            <span class="bg-white/20 px-3 py-1 rounded-full text-sm backdrop-blur">è¯ä¹‰é€‰æ‹©</span>
                            <span class="bg-white/20 px-3 py-1 rounded-full text-sm backdrop-blur">å›æƒ³</span>
                            <span class="bg-white/20 px-3 py-1 rounded-full text-sm backdrop-blur">æ‹¼å†™</span>
                        </div>
                    </div>
                    <span class="material-icons-round absolute -bottom-4 -right-4 text-[180px] opacity-10 group-hover:scale-110 transition-transform">school</span>
                </div>
                <div class="grid grid-rows-2 gap-4">
                    <div onclick="app.startSession('immersive')" class="card p-6 cursor-pointer hover:bg-black/5 dark:hover:bg-white/5 flex flex-col justify-center relative overflow-hidden transition-colors">
                        <h3 class="font-bold text-lg mb-1">æ²‰æµ¸åˆ·è¯</h3>
                        <p class="text-xs opacity-60">å¿«é€Ÿå›é¡¾ (åªçœ‹/å¬)</p>
                        <span class="material-icons-round absolute bottom-2 right-2 text-4xl opacity-10">bolt</span>
                    </div>
                    <div onclick="app.startSession('spell')" class="card p-6 cursor-pointer hover:bg-black/5 dark:hover:bg-white/5 flex flex-col justify-center relative overflow-hidden transition-colors">
                        <h3 class="font-bold text-lg mb-1">éšæ‰‹æ‹¼</h3>
                        <p class="text-xs opacity-60">ä¸“æ³¨æ‹¼å†™ç»ƒä¹ </p>
                        <span class="material-icons-round absolute bottom-2 right-2 text-4xl opacity-10">keyboard</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- REVIEW -->
        <div id="view-review" class="view-page hidden w-full h-full overflow-y-auto p-8">
            <header class="flex items-center gap-4 mb-8">
                <button onclick="app.nav('dashboard')" class="p-2 rounded-full hover:bg-black/5"><span class="material-icons-round">arrow_back</span></button>
                <h1 class="text-2xl font-bold">å¤ä¹ è®¡åˆ’</h1>
            </header>
            <div class="card p-6 mb-6 bg-orange-50 dark:bg-orange-900/20 border border-orange-100 dark:border-orange-800">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-3xl font-bold text-orange-600 dark:text-orange-400" id="total-due-count">0</div>
                        <div class="text-sm opacity-70">å½“å‰åˆ°æœŸæ€»æ•°</div>
                    </div>
                    <button onclick="app.startSession('review_all')" class="btn-filled bg-orange-600 hover:bg-orange-700">
                        <span class="material-icons-round">play_arrow</span> ä¸€é”®æ™ºèƒ½å¤ä¹ 
                    </button>
                </div>
            </div>
            <div id="review-timeline" class="space-y-4 pb-20"></div>
        </div>

        <!-- LIBRARY -->
        <div id="view-library" class="view-page hidden w-full h-full overflow-y-auto p-8">
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">æˆ‘çš„å†…å®¹</h1>
                <div class="flex gap-2">
                    <button onclick="app.openImportModal()" class="btn-tonal text-sm h-10">
                        <span class="material-icons-round text-sm">upload</span> å¯¼å…¥ TXT/ç²˜è´´
                    </button>
                </div>
            </header>
            <div class="flex gap-2 mb-6 border-b border-black/10 dark:border-white/10 pb-4">
                <button onclick="app.renderLibrary('all')" class="px-4 py-1 rounded-full text-sm font-medium bg-[var(--md-sys-color-primary)] text-white lib-filter-btn">å…¨éƒ¨</button>
                <button onclick="app.renderLibrary('learning')" class="px-4 py-1 rounded-full text-sm font-medium border border-gray-500 lib-filter-btn">å­¦ä¹ ä¸­</button>
                <button onclick="app.renderLibrary('mastered')" class="px-4 py-1 rounded-full text-sm font-medium border border-gray-500 lib-filter-btn">å·²æŒæ¡</button>
                <button onclick="app.renderLibrary('wrong')" class="px-4 py-1 rounded-full text-sm font-medium border border-gray-500 lib-filter-btn">é”™è¯æœ¬</button>
            </div>
            <div id="library-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20"></div>
        </div>

        <!-- SETTINGS -->
        <div id="view-settings" class="view-page hidden w-full h-full overflow-y-auto p-8 max-w-3xl mx-auto">
            <h1 class="text-2xl font-bold mb-6">è®¾ç½®</h1>

            <!-- TTS Section -->
            <div class="card mb-6 overflow-hidden">
                <div class="settings-section-header">ğŸ”Š è¯­éŸ³ / TTS</div>

                <!-- Enable toggle -->
                <div class="p-4 flex justify-between items-center border-b border-black/5 dark:border-white/5">
                    <div>
                        <div class="font-bold">è‡ªåŠ¨å‘éŸ³</div>
                        <div class="text-xs opacity-60">æ˜¾ç¤ºå•è¯æ—¶è‡ªåŠ¨æœ—è¯»</div>
                    </div>
                    <input type="checkbox" id="set-tts" class="w-5 h-5 accent-[var(--md-sys-color-primary)]" onchange="app.saveSettings()">
                </div>

                <!-- Voice selector -->
                <div class="p-4 border-b border-black/5 dark:border-white/5">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <div class="font-bold">è¯­éŸ³é€‰æ‹©</div>
                            <div class="text-xs opacity-60">åœ¨çº¿è¯­éŸ³ (å¦‚ Edge) éŸ³è´¨æ›´ä½³ï¼Œéœ€ç½‘ç»œæ”¯æŒ</div>
                        </div>
                        <button class="tts-test-btn" onclick="app.testTTS()">
                            <span class="material-icons-round text-sm">play_circle</span> è¯•å¬
                        </button>
                    </div>

                    <div class="flex gap-2 mb-3">
                        <button onclick="app.filterVoices('all')" id="vf-all" class="px-3 py-1 rounded-full text-xs font-medium bg-[var(--md-sys-color-primary)] text-white voice-filter-btn">å…¨éƒ¨</button>
                        <button onclick="app.filterVoices('online')" id="vf-online" class="px-3 py-1 rounded-full text-xs font-medium border border-gray-400 voice-filter-btn">åœ¨çº¿è¯­éŸ³</button>
                        <button onclick="app.filterVoices('local')" id="vf-local" class="px-3 py-1 rounded-full text-xs font-medium border border-gray-400 voice-filter-btn">æœ¬åœ°è¯­éŸ³</button>
                    </div>

                    <select id="set-voice" class="w-full" onchange="app.saveSettings()">
                        <option value="">-- ç³»ç»Ÿé»˜è®¤ --</option>
                    </select>

                    <div id="voice-info" class="mt-2 text-xs opacity-60 flex items-center gap-1">
                        <span class="material-icons-round text-sm">info</span>
                        <span id="voice-info-text">åŠ è½½è¯­éŸ³åˆ—è¡¨ä¸­â€¦</span>
                    </div>
                </div>

                <!-- Rate -->
                <div class="p-4 border-b border-black/5 dark:border-white/5">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold">è¯­é€Ÿ</span>
                        <span id="set-rate-val" class="text-sm font-mono opacity-70">1.0Ã—</span>
                    </div>
                    <input type="range" id="set-rate" min="0.5" max="2.0" step="0.1" class="w-full accent-[var(--md-sys-color-primary)]" oninput="app.saveSettings()">
                </div>

                <!-- Pitch -->
                <div class="p-4 border-b border-black/5 dark:border-white/5">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold">éŸ³è°ƒ</span>
                        <span id="set-pitch-val" class="text-sm font-mono opacity-70">1.0</span>
                    </div>
                    <input type="range" id="set-pitch" min="0.5" max="2.0" step="0.1" class="w-full accent-[var(--md-sys-color-primary)]" oninput="app.saveSettings()">
                    <div class="text-xs opacity-40 mt-1">æ³¨ï¼šåœ¨çº¿è¯­éŸ³ (Microsoft Edge) ä¸æ”¯æŒéŸ³è°ƒè°ƒèŠ‚</div>
                </div>

                <!-- Volume -->
                <div class="p-4">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold">éŸ³é‡</span>
                        <span id="set-vol-val" class="text-sm font-mono opacity-70">1.0</span>
                    </div>
                    <input type="range" id="set-vol" min="0" max="1" step="0.1" class="w-full accent-[var(--md-sys-color-primary)]" oninput="app.saveSettings()">
                </div>
            </div>

            <!-- Keybindings Section -->
            <div class="card mb-6 overflow-hidden">
                <div class="settings-section-header">âŒ¨ï¸ å¿«æ·é”®</div>
                <div class="p-4 pb-2">
                    <p class="text-xs opacity-50 mb-4">æ¯ä¸ªæ“ä½œå¯ç»‘å®šå¤šä¸ªå¿«æ·é”®ã€‚ç‚¹å‡» <span class="key-badge">+ æ·»åŠ </span> å½•åˆ¶æ–°é”®ï¼Œç‚¹å‡»å·²æœ‰æŒ‰é”®åˆ é™¤ã€‚</p>
                    <div id="keybind-list" class="space-y-3"></div>
                </div>
                <div class="p-4 pt-2 mt-2 border-t border-black/5 dark:border-white/5">
                    <button onclick="app.resetKeys()" class="text-xs opacity-50 hover:opacity-80 flex items-center gap-1">
                        <span class="material-icons-round text-sm">restart_alt</span> é‡ç½®ä¸ºé»˜è®¤å¿«æ·é”®
                    </button>
                </div>
            </div>

            <!-- Danger zone -->
            <div class="card overflow-hidden">
                <div class="settings-section-header">âš ï¸ å±é™©åŒºåŸŸ</div>
                <div class="p-4">
                    <button onclick="app.resetData()" class="w-full py-3 text-red-500 border border-red-200 bg-red-50 rounded-lg hover:bg-red-100 font-bold transition-colors">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                </div>
            </div>
        </div>

        <!-- SESSION -->
        <div id="view-session" class="absolute inset-0 bg-[var(--md-sys-color-surface)] z-50 hidden flex flex-col">
            <div class="h-16 px-6 flex items-center justify-between border-b border-black/5 dark:border-white/5 bg-[var(--md-sys-color-surface)]">
                <button onclick="app.exitSession()" class="p-2 -ml-2 rounded-full hover:bg-black/5 text-[var(--md-sys-color-outline)] transition-colors">
                    <span class="material-icons-round">close</span>
                </button>
                <div class="flex flex-col items-center">
                    <span class="text-xs font-bold tracking-widest opacity-50" id="session-mode-label">LEARNING</span>
                    <div id="session-progress-dots" class="flex gap-1 mt-1"></div>
                </div>
                <div class="w-10"></div>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center p-8 relative">
                <div id="undo-toast" class="absolute top-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-5 py-3 rounded-full text-sm shadow-xl flex items-center gap-4 opacity-0 translate-y-[-20px] transition-all z-[70] pointer-events-auto">
                    <span>å·²æ ‡è®°ä¸ºè®¤è¯†</span>
                    <button onclick="Session.undo()" class="text-yellow-400 font-bold hover:underline">æ’¤é”€ (æˆ‘é”™äº†)</button>
                </div>
                <div id="study-card" class="w-full max-w-2xl text-center"></div>
            </div>

            <div id="session-controls" class="h-28 border-t border-black/5 dark:border-white/5 flex items-center justify-between px-10 bg-[var(--md-sys-color-surface-container)]"></div>
        </div>
    </main>

    <!-- IMPORT MODAL -->
    <div id="modal-import" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-4">
        <div class="card w-full max-w-lg p-6 shadow-2xl slide-up-anim bg-[var(--md-sys-color-surface)]">
            <h2 class="text-xl font-bold mb-4">å¯¼å…¥å•è¯</h2>
            <textarea id="import-area" class="w-full h-40 p-3 border rounded-xl bg-transparent font-mono text-sm mb-4 border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-[var(--md-sys-color-primary)] outline-none" placeholder="å•è¯|é‡Šä¹‰|ä¾‹å¥|ç¿»è¯‘ (æ¯è¡Œä¸€ä¸ª)"></textarea>
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('modal-import').classList.add('hidden')" class="btn-tonal bg-transparent border border-gray-300 dark:border-gray-600 h-10">å–æ¶ˆ</button>
                <button onclick="app.doImport()" class="btn-filled h-10">å¼€å§‹å¯¼å…¥</button>
            </div>
            <div class="mt-4 pt-4 border-t border-black/10 text-center">
                <label class="btn-tonal w-full cursor-pointer h-10 opacity-70 hover:opacity-100">
                    <span class="material-icons-round text-sm">upload_file</span> ä¸Šä¼  TXT æ–‡ä»¶
                    <input type="file" accept=".txt" class="hidden" onchange="app.handleFile(this)">
                </label>
            </div>
        </div>
    </div>

    <script>
    // â”€â”€â”€ DATA STORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const DB = {
        key: 'LexiFlowPro_V3',
        defaultSettings() {
            return {
                tts: true,
                rate: 1.0,
                pitch: 1.0,
                volume: 1.0,
                voiceName: '',   // SpeechSynthesisVoice.name
                theme: 'light',
                // Multi-key bindings: each action maps to an ARRAY of keys
                keys: {
                    know:    [' '],
                    unknown: ['k'],
                    speak:   ['p'],
                    master:  ['m'],
                    undo:    ['u'],
                    next:    ['n']
                }
            };
        },
        data: {
            words: [],
            stats: { todayTime: 0, todayLearned: 0, todayReviewed: 0, date: new Date().toDateString() },
            settings: null
        },
        init() {
            const raw = localStorage.getItem(this.key);
            if (raw) {
                try {
                    this.data = JSON.parse(raw);
                    // Migrate old single-key settings to arrays
                    if (this.data.settings && !Array.isArray(this.data.settings.keys?.know)) {
                        const old = this.data.settings.keys || {};
                        const def = this.defaultSettings().keys;
                        this.data.settings.keys = {};
                        for (const [action, defKeys] of Object.entries(def)) {
                            const oldVal = old[action];
                            this.data.settings.keys[action] = oldVal ? [oldVal] : defKeys;
                        }
                    }
                    // Fill missing settings keys
                    const def = this.defaultSettings();
                    for (const k of Object.keys(def)) {
                        if (this.data.settings[k] === undefined) this.data.settings[k] = def[k];
                    }
                } catch (e) { console.error(e); this.seed(); }
            } else {
                this.seed();
            }
            if (!this.data.settings) this.data.settings = this.defaultSettings();

            if (this.data.stats.date !== new Date().toDateString()) {
                this.data.stats = { todayTime: 0, todayLearned: 0, todayReviewed: 0, date: new Date().toDateString() };
            }
            this.save();
        },
        save() { localStorage.setItem(this.key, JSON.stringify(this.data)); },
        seed() {
            this.data = {
                words: [],
                stats: { todayTime: 0, todayLearned: 0, todayReviewed: 0, date: new Date().toDateString() },
                settings: this.defaultSettings()
            };
            const demo = [
                { w: "ephemeral",   m: "çŸ­æš‚çš„",           e: "Fashion is ephemeral.",             c: "æ—¶å°šæ˜¯çŸ­æš‚çš„ã€‚" },
                { w: "serendipity", m: "æ„å¤–å‘ç°çå®çš„è¿æ°”", e: "It was pure serendipity.",           c: "è¿™çº¯å±æœºç¼˜å·§åˆã€‚" },
                { w: "resilient",   m: "æœ‰å¼¹æ€§çš„ï¼›èƒ½å¤åŸçš„", e: "She is resilient.",                 c: "å¥¹å¾ˆæœ‰éŸ§æ€§ã€‚" },
                { w: "ubiquitous",  m: "æ— æ‰€ä¸åœ¨çš„",         e: "Smartphones are ubiquitous.",       c: "æ™ºèƒ½æ‰‹æœºæ— å¤„ä¸åœ¨ã€‚" },
                { w: "meticulous",  m: "ä¸€ä¸ä¸è‹Ÿçš„",         e: "He is meticulous about details.",   c: "ä»–å¯¹ç»†èŠ‚ä¸€ä¸ä¸è‹Ÿã€‚" }
            ];
            demo.forEach(d => this.addWord(d.w, d.m, d.e, d.c));
        },
        addWord(w, m, e = '', c = '') {
            if (this.data.words.some(x => x.word.toLowerCase() === w.toLowerCase())) return;
            this.data.words.push({
                id: crypto.randomUUID(), word: w, meaning: m, ex: e, cn: c,
                status: 'new', stage: 0, nextReview: 0, interval: 0, learnedDate: null
            });
            this.save();
        },
        deleteWord(id) {
            this.data.words = this.data.words.filter(w => w.id !== id);
            this.save();
        }
    };

    // â”€â”€â”€ SRS ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SRS = {
        intervals: [1, 10, 60, 720, 1440, 2880, 5760, 10080],
        getDue() {
            const now = Date.now();
            return DB.data.words.filter(w => w.status !== 'new' && w.status !== 'mastered' && w.nextReview <= now);
        },
        process(word, isCorrect) {
            const now = Date.now();
            if (!isCorrect) { word.interval = 0; word.nextReview = now; return; }
            let idx = this.intervals.findIndex(i => i > word.interval);
            if (idx === -1) idx = this.intervals.length - 1;
            else if (idx > 0 && word.interval === this.intervals[idx - 1]) idx++;
            if (word.interval === 0) idx = 0;
            word.interval = this.intervals[idx];
            word.nextReview = now + word.interval * 60000;
        }
    };

    // â”€â”€â”€ SESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const Session = {
        active: false, queue: [], currentWord: null,
        phase: 'recall', undoTimer: null, lastPassed: null, mode: 'learn',

        start(mode, filterDate = null) {
            let list = [];
            const now = Date.now();
            if (mode === 'learn') {
                const learning = DB.data.words.filter(w => w.status === 'learning' && w.nextReview <= now);
                const newWords = DB.data.words.filter(w => w.status === 'new').slice(0, 10);
                list = [...learning, ...newWords].slice(0, 20);
            } else if (mode === 'review') {
                list = filterDate
                    ? DB.data.words.filter(w => w.learnedDate === filterDate)
                    : SRS.getDue();
            } else if (mode === 'review_all') {
                list = SRS.getDue();
            } else if (mode === 'immersive' || mode === 'spell') {
                list = DB.data.words.filter(w => w.status !== 'new').sort(() => 0.5 - Math.random()).slice(0, 20);
            }
            if (list.length === 0) return app.toast("å½“å‰æ²¡æœ‰ç¬¦åˆè¯¥æ¨¡å¼çš„å­¦ä¹ å†…å®¹ï¼");
            this.queue = list.map(w => ({ ...w, sessionStage: (w.status === 'new' || w.status === 'learning') ? 0 : 4 }));
            this.mode = mode;
            this.active = true;
            this.lastPassed = null;
            app.toggleView('session');
            this.next();
        },

        next() {
            if (this.queue.length === 0) { this.end(); return; }
            this.currentWord = this.queue[0];
            const stage = this.currentWord.sessionStage;
            if (this.mode === 'spell') this.phase = 'spell';
            else if (this.mode === 'immersive') this.phase = 'immersive';
            else if (this.currentWord.status === 'review') this.phase = 'recall';
            else {
                if (stage === 0) this.phase = 'recall';
                else if (stage === 1) this.phase = 'select';
                else if (stage === 2) this.phase = 'spell';
                else this.phase = 'recall';
            }
            app.renderCard(this.currentWord, this.phase);
        },

        handleResult(success) {
            const w = this.currentWord;
            clearTimeout(this.undoTimer);
            const undoEl = document.getElementById('undo-toast');
            undoEl.classList.add('translate-y-[-20px]', 'opacity-0');
            undoEl.classList.remove('pointer-events-auto');
            const dbWord = DB.data.words.find(x => x.id === w.id);

            if (!success) {
                w.sessionStage = 0;
                if (dbWord) { dbWord.status = 'learning'; SRS.process(dbWord, false); DB.save(); }
                this.queue.shift();
                this.queue.push(w);
                this.phase = 'feedback';
                app.renderFeedback(w);
            } else {
                if (this.mode === 'learn' || w.status === 'learning' || w.status === 'new') {
                    w.sessionStage++;
                    if (w.sessionStage > 2) {
                        if (dbWord) {
                            dbWord.status = 'review';
                            dbWord.learnedDate = new Date().toDateString();
                            dbWord.interval = 1440;
                            dbWord.nextReview = Date.now() + 1440 * 60000;
                            DB.data.stats.todayLearned++;
                            app.toast(`å·²åˆæ­¥æŒæ¡: ${w.word}`);
                        }
                        this.queue.shift();
                    } else {
                        this.queue.shift();
                        const insertPos = Math.min(this.queue.length, 3);
                        this.queue.splice(insertPos, 0, w);
                    }
                } else {
                    if (dbWord) { SRS.process(dbWord, true); DB.data.stats.todayReviewed++; }
                    this.queue.shift();
                }
                DB.save();
                if (this.phase === 'recall' && this.mode !== 'immersive') {
                    this.lastPassed = w;
                    this.showUndo();
                }
                this.next();
            }
        },

        showUndo() {
            const t = document.getElementById('undo-toast');
            t.classList.remove('translate-y-[-20px]', 'opacity-0');
            t.classList.add('pointer-events-auto');
            this.undoTimer = setTimeout(() => {
                t.classList.add('translate-y-[-20px]', 'opacity-0');
                t.classList.remove('pointer-events-auto');
            }, 3000);
        },

        undo() {
            if (!this.lastPassed) return;
            const w = this.lastPassed;
            const dbWord = DB.data.words.find(x => x.id === w.id);
            if (dbWord) { dbWord.status = 'learning'; SRS.process(dbWord, false); DB.save(); }
            w.sessionStage = 0;
            this.queue.unshift(w);
            document.getElementById('undo-toast').classList.add('translate-y-[-20px]', 'opacity-0');
            this.next();
        },

        end() {
            this.active = false;
            app.nav('dashboard');
            app.toast("æœ¬æ¬¡å­¦ä¹ å®Œæˆï¼ğŸ‰");
        }
    };

    // â”€â”€â”€ TTS MANAGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const TTS = {
        voices: [],
        filteredVoices: [],
        currentFilter: 'all',

        loadVoices() {
            return new Promise(resolve => {
                const load = () => {
                    this.voices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
                    if (this.voices.length > 0) { this.filteredVoices = this.voices; resolve(); }
                };
                load();
                if (this.voices.length === 0) {
                    window.speechSynthesis.onvoiceschanged = () => { load(); resolve(); };
                    // Timeout fallback
                    setTimeout(resolve, 2000);
                }
            });
        },

        isOnlineVoice(voice) {
            return !voice.localService;
        },

        getVoiceDisplayName(voice) {
            const isOnline = this.isOnlineVoice(voice);
            const badge = isOnline ? 'ğŸŒ' : 'ğŸ’¾';
            // Extract readable name (strip lang codes)
            let name = voice.name
                .replace(/Microsoft\s+/i, '')
                .replace(/\(Natural\)\s*/i, 'â˜… ')
                .replace(/Online\s*/i, '');
            return `${badge} ${name} [${voice.lang}]`;
        },

        getCurrentVoice() {
            const name = DB.data.settings.voiceName;
            if (!name) return null;
            return this.voices.find(v => v.name === name) || null;
        },

        speak(text) {
            const s = DB.data.settings;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            u.rate = parseFloat(s.rate);
            u.pitch = parseFloat(s.pitch);
            u.volume = parseFloat(s.volume);
            const voice = this.getCurrentVoice();
            if (voice) u.voice = voice;
            window.speechSynthesis.speak(u);
        },

        populateSelect(filterType = 'all') {
            this.currentFilter = filterType;
            const sel = document.getElementById('set-voice');
            if (!sel) return;

            let list = this.voices;
            if (filterType === 'online') list = this.voices.filter(v => this.isOnlineVoice(v));
            if (filterType === 'local')  list = this.voices.filter(v => !this.isOnlineVoice(v));
            this.filteredVoices = list;

            sel.innerHTML = '<option value="">-- ç³»ç»Ÿé»˜è®¤ --</option>';
            list.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.name;
                opt.textContent = this.getVoiceDisplayName(v);
                if (v.name === DB.data.settings.voiceName) opt.selected = true;
                sel.appendChild(opt);
            });

            // Voice info
            const infoEl = document.getElementById('voice-info-text');
            const online = this.voices.filter(v => this.isOnlineVoice(v)).length;
            const local  = this.voices.filter(v => !this.isOnlineVoice(v)).length;
            if (infoEl) infoEl.textContent = `å…± ${this.voices.length} ä¸ªè‹±è¯­è¯­éŸ³ (åœ¨çº¿: ${online}, æœ¬åœ°: ${local})`;

            // Update filter button styles
            document.querySelectorAll('.voice-filter-btn').forEach(btn => {
                btn.classList.remove('bg-[var(--md-sys-color-primary)]', 'text-white');
                btn.classList.add('border', 'border-gray-400');
            });
            const active = document.getElementById('vf-' + filterType);
            if (active) {
                active.classList.add('bg-[var(--md-sys-color-primary)]', 'text-white');
                active.classList.remove('border', 'border-gray-400');
            }
        }
    };

    // â”€â”€â”€ KEYBINDINGS MANAGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const KB = {
        actionLabels: {
            know:    'è®¤è¯† / ä¸‹ä¸€ä¸ª',
            unknown: 'ä¸è®¤è¯†',
            speak:   'æœ—è¯»å•è¯',
            master:  'æ–©è¯ (æ°¸ä¹…æŒæ¡)',
            undo:    'æ’¤é”€ä¸Šä¸€æ­¥',
            next:    'ç»§ç»­ (åé¦ˆé¡µ)'
        },
        actionIcons: {
            know:    'check_circle',
            unknown: 'cancel',
            speak:   'volume_up',
            master:  'delete_forever',
            undo:    'undo',
            next:    'arrow_forward'
        },
        recording: null, // { action, resolve }

        defaultKeys() {
            return {
                know:    [' '],
                unknown: ['k'],
                speak:   ['p'],
                master:  ['m'],
                undo:    ['u'],
                next:    ['n']
            };
        },

        fmtKey(k) {
            if (k === ' ')          return 'Space';
            if (k === 'ArrowUp')    return 'â†‘';
            if (k === 'ArrowDown')  return 'â†“';
            if (k === 'ArrowLeft')  return 'â†';
            if (k === 'ArrowRight') return 'â†’';
            if (k === 'Enter')      return 'Enter';
            if (k === 'Escape')     return 'Esc';
            if (k === 'Backspace')  return 'âŒ«';
            if (k === 'Tab')        return 'Tab';
            return k.length === 1 ? k.toUpperCase() : k;
        },

        matchesAction(e, action) {
            const keys = DB.data.settings.keys[action] || [];
            return keys.some(k => {
                if (k === ' ') return e.key === ' ' || e.code === 'Space';
                return e.key.toLowerCase() === k.toLowerCase();
            });
        },

        renderPanel() {
            const container = document.getElementById('keybind-list');
            if (!container) return;
            const keys = DB.data.settings.keys;
            container.innerHTML = Object.entries(this.actionLabels).map(([action, label]) => {
                const actionKeys = keys[action] || [];
                const badgeHtml = actionKeys.map(k =>
                    `<span class="key-badge cursor-pointer hover:bg-red-100 dark:hover:bg-red-900 hover:border-red-400 transition-colors group relative" title="ç‚¹å‡»åˆ é™¤" onclick="KB.removeKey('${action}', '${k}')">
                        ${this.fmtKey(k)}
                        <span class="absolute -top-1 -right-1 text-red-500 text-[10px] opacity-0 group-hover:opacity-100 leading-none">âœ•</span>
                    </span>`
                ).join('');
                return `
                    <div class="keybind-row">
                        <span class="material-icons-round text-lg opacity-50 shrink-0">${this.actionIcons[action]}</span>
                        <span class="text-sm font-medium flex-1">${label}</span>
                        <div class="flex gap-1.5 items-center flex-wrap justify-end">
                            ${badgeHtml}
                            <button onclick="KB.recordKey('${action}')" id="kbtn-${action}"
                                class="key-badge cursor-pointer hover:bg-[var(--md-sys-color-primary-container)] transition-colors text-[var(--md-sys-color-primary)] border-dashed">
                                + æ·»åŠ 
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        },

        removeKey(action, key) {
            const keys = DB.data.settings.keys[action];
            if (!keys) return;
            DB.data.settings.keys[action] = keys.filter(k => k !== key);
            DB.save();
            this.renderPanel();
        },

        recordKey(action) {
            const btn = document.getElementById(`kbtn-${action}`);
            if (!btn) return;
            // Cancel previous recording
            if (this.recording) this.cancelRecord();

            btn.textContent = 'æŒ‰ä»»æ„é”®â€¦';
            btn.classList.add('recording-btn');

            const handler = (e) => {
                e.preventDefault();
                e.stopPropagation();
                const key = e.key;
                if (key === 'Escape') { this.cancelRecord(); return; }

                // Prevent duplicate within same action
                const existing = DB.data.settings.keys[action] || [];
                if (!existing.includes(key)) {
                    DB.data.settings.keys[action] = [...existing, key];
                    DB.save();
                } else {
                    app.toast('è¯¥é”®å·²ç»‘å®šåˆ°æ­¤æ“ä½œ');
                }
                this.recording = null;
                document.removeEventListener('keydown', handler, { capture: true });
                this.renderPanel();
            };

            this.recording = { action, handler };
            document.addEventListener('keydown', handler, { capture: true, once: false });

            // Auto cancel after 8s
            setTimeout(() => { if (this.recording?.action === action) this.cancelRecord(); }, 8000);
        },

        cancelRecord() {
            if (!this.recording) return;
            document.removeEventListener('keydown', this.recording.handler, { capture: true });
            this.recording = null;
            this.renderPanel();
        }
    };

    // â”€â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const app = {
        async init() {
            DB.init();
            this.setupTheme();
            this.setupKeybindings();
            this.nav('dashboard');

            // Load voices (async, browser may delay)
            await TTS.loadVoices();

            setInterval(() => {
                if (Session.active && !document.hidden) {
                    DB.data.stats.todayTime += (1 / 60);
                }
            }, 1000);
        },

        setupTheme() {
            if (DB.data.settings.theme === 'dark') {
                document.documentElement.classList.add('dark');
                const icon = document.getElementById('theme-icon');
                if (icon) icon.innerText = 'light_mode';
            }
        },

        nav(view) {
            document.querySelectorAll('.view-page').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + view).classList.remove('hidden');
            document.getElementById('view-session').classList.add('hidden');
            document.querySelectorAll('.nav-rail-item').forEach(el => el.classList.remove('active'));
            const btn = document.getElementById('nav-' + view);
            if (btn) btn.classList.add('active');
            if (view === 'dashboard') this.renderDashboard();
            if (view === 'review') this.renderReviewPage();
            if (view === 'library') this.renderLibrary('all');
            if (view === 'settings') this.renderSettings();
        },

        toggleView(id) {
            if (id === 'session') document.getElementById('view-session').classList.remove('hidden');
            else document.getElementById('view-session').classList.add('hidden');
        },

        // â”€â”€ Renderers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        renderDashboard() {
            const s = DB.data.stats;
            document.getElementById('stat-time').innerText = Math.floor(s.todayTime) + 'm';
            document.getElementById('stat-mastered').innerText = DB.data.words.filter(w => w.status === 'mastered' || w.status === 'review').length;
            document.getElementById('stat-due').innerText = SRS.getDue().length;
            document.getElementById('stat-learned').innerText = s.todayLearned;
            const masteredToday = DB.data.words.filter(w => w.status === 'review' && w.learnedDate === new Date().toDateString());
            const ticker = document.getElementById('mastered-ticker');
            if (masteredToday.length > 0) {
                ticker.innerHTML = masteredToday.map(w => `<span class="inline-block bg-white dark:bg-white/10 px-2 rounded mr-2">${w.word}</span>`).join('');
            } else {
                ticker.innerText = "æš‚æ— æ–°æŒæ¡å•è¯ï¼Œå¿«å»å­¦ä¹ å§ï¼";
            }
        },

        renderReviewPage() {
            const list = document.getElementById('review-timeline');
            const due = SRS.getDue();
            document.getElementById('total-due-count').innerText = due.length;
            const groups = {};
            DB.data.words.forEach(w => {
                if (w.learnedDate) {
                    if (!groups[w.learnedDate]) groups[w.learnedDate] = [];
                    groups[w.learnedDate].push(w);
                }
            });
            const sortedDates = Object.keys(groups).sort((a, b) => new Date(b) - new Date(a));
            list.innerHTML = sortedDates.map(date => {
                const words = groups[date];
                const weekday = new Date(date).toLocaleDateString('zh-CN', { weekday: 'long' });
                const samples = words.slice(0, 5).map(w => w.word).join(', ');
                const dueCount = words.filter(w => w.nextReview <= Date.now() && w.status !== 'mastered').length;
                return `
                    <div class="card p-4 hover:border-[var(--md-sys-color-primary)] border border-transparent transition-all flex justify-between items-center bg-white dark:bg-gray-800">
                        <div class="flex-1">
                            <div class="flex items-center mb-1">
                                <span class="font-bold text-lg">${date}</span>
                                <span class="text-xs opacity-60 ml-2">${weekday}</span>
                            </div>
                            <div class="text-sm opacity-60 truncate max-w-md">${samples}...</div>
                        </div>
                        ${dueCount > 0
                            ? `<button onclick="app.startSession('review', '${date}')" class="btn-tonal h-10 text-xs shrink-0 ml-4">å¤ä¹ æ­¤ç»„ (${dueCount})</button>`
                            : '<span class="text-green-500 text-sm font-bold ml-4">âœ“ å·²å®Œæˆ</span>'
                        }
                    </div>`;
            }).join('') || '<div class="text-center opacity-50 py-10">æš‚æ— å†å²è®°å½•</div>';
        },

        renderLibrary(filter) {
            const list = document.getElementById('library-list');
            let words = DB.data.words;
            if (filter === 'learning') words = words.filter(w => w.status === 'learning' || w.status === 'new');
            if (filter === 'mastered') words = words.filter(w => w.status === 'mastered' || w.status === 'review');
            if (filter === 'wrong') words = words.filter(w => w.interval === 0 && w.status === 'learning');
            list.innerHTML = words.map(w => `
                <div class="card p-4 flex justify-between items-center group hover:bg-black/5 dark:hover:bg-white/5 transition-colors">
                    <div>
                        <div class="font-bold text-lg">${w.word}</div>
                        <div class="text-xs opacity-60 truncate max-w-[150px]">${w.meaning}</div>
                    </div>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="app.speak('${w.word}')" class="p-2 hover:bg-black/10 dark:hover:bg-white/10 rounded-full"><span class="material-icons-round text-sm">volume_up</span></button>
                        <button onclick="app.deleteWord('${w.id}')" class="p-2 hover:bg-red-100 text-red-500 rounded-full"><span class="material-icons-round text-sm">delete</span></button>
                    </div>
                </div>
            `).join('') || '<div class="col-span-full text-center opacity-50 py-10">ç©ºç©ºå¦‚ä¹Ÿ</div>';
        },

        renderSettings() {
            const s = DB.data.settings;
            document.getElementById('set-tts').checked = s.tts;
            document.getElementById('set-rate').value = s.rate;
            document.getElementById('set-rate-val').innerText = s.rate + 'Ã—';
            document.getElementById('set-pitch').value = s.pitch;
            document.getElementById('set-pitch-val').innerText = parseFloat(s.pitch).toFixed(1);
            document.getElementById('set-vol').value = s.volume;
            document.getElementById('set-vol-val').innerText = parseFloat(s.volume).toFixed(1);

            // Populate voices (async safe)
            TTS.loadVoices().then(() => {
                TTS.populateSelect(TTS.currentFilter);
                // Set saved voice
                const sel = document.getElementById('set-voice');
                if (sel && s.voiceName) sel.value = s.voiceName;
            });

            KB.renderPanel();
        },

        // â”€â”€ Card Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        renderCard(word, phase) {
            const container = document.getElementById('study-card');
            const controls  = document.getElementById('session-controls');
            const label     = document.getElementById('session-mode-label');
            const dots      = document.getElementById('session-progress-dots');

            label.innerText = { immersive: 'IMMERSIVE', recall: 'RECALL', select: 'SELECT', spell: 'SPELL', feedback: 'OOPS' }[phase] || phase.toUpperCase();

            let dotHtml = '';
            for (let i = 0; i < 3; i++) {
                const active = (word.sessionStage || 0) > i;
                dotHtml += `<div class="w-2 h-2 rounded-full ${active ? 'bg-[var(--md-sys-color-primary)]' : 'bg-gray-300 dark:bg-gray-600'}"></div>`;
            }
            dots.innerHTML = Session.mode === 'learn' ? dotHtml : '';

            if (DB.data.settings.tts && phase !== 'select') this.speak(word.word);

            // â”€â”€ Key hints for current mode
            const hintKnow    = (DB.data.settings.keys.know    || []).map(k => `<span class="key-badge">${KB.fmtKey(k)}</span>`).join('');
            const hintUnknown = (DB.data.settings.keys.unknown || []).map(k => `<span class="key-badge">${KB.fmtKey(k)}</span>`).join('');

            if (phase === 'recall' || phase === 'immersive') {
                container.innerHTML = `
                    <div class="text-6xl font-bold mb-6 text-[var(--md-sys-color-primary)] slide-up-anim">${word.word}</div>
                    <div class="text-sm opacity-60 mb-8 cursor-pointer hover:text-[var(--md-sys-color-primary)]" onclick="app.speak('${word.word}')">ğŸ”Š ç‚¹å‡»å‘éŸ³</div>
                    ${phase === 'immersive' ? `<div class="text-2xl font-medium slide-up-anim">${word.meaning}</div>` : ''}
                `;
                if (phase === 'immersive') {
                    controls.innerHTML = `<button onclick="Session.handleResult(true)" class="btn-filled w-full">ä¸‹ä¸€ä¸ª</button>`;
                } else {
                    controls.innerHTML = `
                        <div class="flex items-center gap-4 w-full justify-between max-w-xl mx-auto">
                            <button onclick="Session.handleResult(true)" class="btn-filled flex-1 h-14 text-lg">
                                <span class="material-icons-round">check</span> è®¤è¯† / ä¸‹ä¸€ä¸ª
                            </button>
                            <div class="flex gap-2">
                                <button onclick="app.killWord()" class="btn-danger-tonal px-4" title="æ–©è¯ (æ°¸ä¹…æŒæ¡)"><span class="material-icons-round">delete_forever</span></button>
                                <button onclick="Session.handleResult(false)" class="btn-danger-tonal h-14 w-32 flex-col gap-0 text-xs">
                                    <span class="material-icons-round text-xl">close</span> ä¸è®¤è¯†
                                </button>
                            </div>
                        </div>
                        <div class="absolute bottom-2 left-0 w-full text-center text-[10px] opacity-30 pointer-events-none flex justify-center gap-3">
                            <span>è®¤è¯†: ${hintKnow}</span>
                            <span>ä¸è®¤è¯†: ${hintUnknown}</span>
                        </div>
                    `;
                }
            } else if (phase === 'select') {
                const pool = DB.data.words.filter(w => w.id !== word.id);
                let distractors = pool.length < 3
                    ? ["Distractor 1", "Distractor 2", "Distractor 3"]
                    : pool.sort(() => 0.5 - Math.random()).slice(0, 3).map(w => w.meaning);
                const options = [word.meaning, ...distractors].sort(() => 0.5 - Math.random());
                container.innerHTML = `
                    <div class="text-4xl font-bold mb-8">${word.word}</div>
                    <div class="grid grid-cols-1 gap-3 w-full max-w-md mx-auto">
                        ${options.map((opt, i) => `
                            <button onclick="Session.handleResult('${opt.replace(/'/g,"\\'")}' === '${word.meaning.replace(/'/g,"\\'")}')" class="p-4 rounded-xl border border-gray-300 dark:border-gray-700 hover:bg-[var(--md-sys-color-primary-container)] text-left transition-colors relative choice-btn">
                                <span class="absolute left-4 opacity-40 font-mono text-xs border border-current rounded px-1">${i + 1}</span>
                                <span class="pl-8">${opt}</span>
                            </button>
                        `).join('')}
                    </div>
                `;
                controls.innerHTML = `<div class="text-xs opacity-50 w-full text-center">è¯·é€‰æ‹©æ­£ç¡®é‡Šä¹‰ (æ•°å­—é”® 1â€“4)</div>`;
            } else if (phase === 'spell') {
                container.innerHTML = `
                    <div class="text-sm opacity-60 mb-2">è¯·æ‹¼å†™å•è¯</div>
                    <div class="text-2xl font-bold mb-6">${word.meaning}</div>
                    <input type="text" id="spell-input" class="w-full text-center text-4xl bg-transparent border-b-2 border-[var(--md-sys-color-primary)] outline-none py-2 font-mono" autocomplete="off">
                `;
                controls.innerHTML = `
                    <button onclick="app.checkSpelling('${word.word}')" class="btn-filled w-full">æäº¤ (Enter)</button>
                    <button onclick="app.hintSpelling('${word.word}')" class="absolute bottom-4 right-10 text-xs opacity-50 hover:opacity-100">æç¤º</button>
                `;
                setTimeout(() => document.getElementById('spell-input')?.focus(), 100);
            }
        },

        renderFeedback(word) {
            const container = document.getElementById('study-card');
            const controls  = document.getElementById('session-controls');
            container.innerHTML = `
                <div class="text-6xl mb-4 shake-anim">âŒ</div>
                <div class="text-4xl font-bold text-red-500 mb-2">${word.word}</div>
                <div class="text-2xl font-medium mb-4">${word.meaning}</div>
                <div class="bg-black/5 dark:bg-white/5 p-4 rounded-xl text-left text-sm w-full max-w-md mx-auto">
                    <div class="italic mb-1 text-[var(--md-sys-color-primary)]">${word.ex}</div>
                    <div class="opacity-70">${word.cn}</div>
                </div>
            `;
            controls.innerHTML = `
                <button id="btn-feedback-next" onclick="Session.next()" class="btn-tonal w-full font-bold h-14 text-lg">
                    çŸ¥é“äº†ï¼Œä¸‹ä¸€ä¸ª (Space)
                </button>
            `;
        },

        checkSpelling(target) {
            const input = document.getElementById('spell-input');
            if (!input) return;
            const val = input.value.trim().toLowerCase();
            if (val === target.toLowerCase()) {
                Session.handleResult(true);
            } else {
                input.classList.add('shake-anim');
                setTimeout(() => input.classList.remove('shake-anim'), 400);
                Session.handleResult(false);
            }
        },

        hintSpelling(word) {
            const input = document.getElementById('spell-input');
            if (input) { input.value = word.substring(0, 1) + '...'; input.focus(); }
        },

        // â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        startSession(mode, date) { Session.start(mode, date); },
        exitSession() { Session.end(); },

        killWord() {
            if (confirm("ç¡®å®šæ–©è¯ï¼Ÿï¼ˆæ°¸ä¹…æŒæ¡ï¼Œä¸å†å¤ä¹ ï¼‰")) {
                const w = Session.currentWord;
                const dbWord = DB.data.words.find(x => x.id === w.id);
                if (dbWord) { dbWord.status = 'mastered'; dbWord.learnedDate = new Date().toDateString(); DB.save(); }
                Session.queue.shift();
                Session.next();
            }
        },
        deleteWord(id) {
            if (confirm("åˆ é™¤æ­¤å•è¯ï¼Ÿ")) { DB.deleteWord(id); this.renderLibrary('all'); }
        },

        speak(text) {
            if (!DB.data.settings.tts) return;
            TTS.speak(text);
        },

        testTTS() {
            const sel = document.getElementById('set-voice');
            if (sel) DB.data.settings.voiceName = sel.value;
            TTS.speak("Hello, this is a test of your selected voice.");
        },

        filterVoices(type) {
            TTS.populateSelect(type);
        },

        toast(msg) {
            const t = document.createElement('div');
            t.className = "bg-gray-800 text-white px-6 py-3 rounded-full shadow-xl slide-up-anim";
            t.textContent = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 2500);
        },

        // â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        saveSettings() {
            const s = DB.data.settings;
            s.tts = document.getElementById('set-tts').checked;
            s.rate = parseFloat(document.getElementById('set-rate').value);
            s.pitch = parseFloat(document.getElementById('set-pitch').value);
            s.volume = parseFloat(document.getElementById('set-vol').value);
            const sel = document.getElementById('set-voice');
            if (sel) s.voiceName = sel.value;

            document.getElementById('set-rate-val').innerText  = s.rate.toFixed(1) + 'Ã—';
            document.getElementById('set-pitch-val').innerText = s.pitch.toFixed(1);
            document.getElementById('set-vol-val').innerText   = s.volume.toFixed(1);
            DB.save();
        },

        resetKeys() {
            if (confirm("é‡ç½®æ‰€æœ‰å¿«æ·é”®ä¸ºé»˜è®¤ï¼Ÿ")) {
                DB.data.settings.keys = KB.defaultKeys();
                DB.save();
                KB.renderPanel();
                this.toast("å·²é‡ç½®ä¸ºé»˜è®¤å¿«æ·é”®");
            }
        },

        toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            DB.data.settings.theme = isDark ? 'dark' : 'light';
            DB.save();
            document.getElementById('theme-icon').innerText = isDark ? 'light_mode' : 'dark_mode';
        },

        // â”€â”€ Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        openImportModal() { document.getElementById('modal-import').classList.remove('hidden'); },

        doImport() {
            const txt = document.getElementById('import-area').value;
            if (!txt) return;
            let c = 0;
            txt.split('\n').forEach(l => {
                const parts = l.split(/[|ï½œ]/);
                const w = parts[0]?.trim(); const m = parts[1]?.trim();
                const e = parts[2]?.trim() || ''; const cn = parts[3]?.trim() || '';
                if (w && m) { DB.addWord(w, m, e, cn); c++; }
            });
            this.toast(`æˆåŠŸå¯¼å…¥ ${c} ä¸ªå•è¯`);
            document.getElementById('modal-import').classList.add('hidden');
            document.getElementById('import-area').value = '';
            this.renderLibrary('all');
        },

        handleFile(input) {
            const f = input.files[0];
            const r = new FileReader();
            r.onload = e => { document.getElementById('import-area').value = e.target.result; };
            r.readAsText(f);
        },

        resetData() {
            if (confirm("âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
                localStorage.removeItem(DB.key);
                location.reload();
            }
        },

        // â”€â”€ Keyboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        setupKeybindings() {
            document.addEventListener('keydown', (e) => {
                if (!Session.active) return;
                if (!document.getElementById('modal-import').classList.contains('hidden')) return;

                if (Session.phase === 'spell') {
                    if (e.key === 'Enter') { e.preventDefault(); app.checkSpelling(Session.currentWord.word); }
                    return;
                }

                // Feedback page: any "next" key or space continues
                if (Session.phase === 'feedback') {
                    if (KB.matchesAction(e, 'next') || e.key === ' ' || e.code === 'Space') {
                        e.preventDefault();
                        Session.next();
                    }
                    return;
                }

                // Prevent page scroll on Space
                if (e.key === ' ' || e.code === 'Space') e.preventDefault();

                if (KB.matchesAction(e, 'know') && (Session.phase === 'recall' || Session.phase === 'immersive')) {
                    Session.handleResult(true);
                } else if (KB.matchesAction(e, 'unknown') && Session.phase === 'recall') {
                    Session.handleResult(false);
                } else if (KB.matchesAction(e, 'speak')) {
                    app.speak(Session.currentWord.word);
                } else if (KB.matchesAction(e, 'master')) {
                    app.killWord();
                } else if (KB.matchesAction(e, 'undo')) {
                    Session.undo();
                }

                // Number keys for multiple choice
                if (Session.phase === 'select' && ['1','2','3','4'].includes(e.key)) {
                    const choices = document.querySelectorAll('.choice-btn');
                    const choice = choices[parseInt(e.key) - 1];
                    if (choice) choice.click();
                }
            });
        }
    };

    app.init();
    </script>
</body>
</html>
